@model ProyectoBeta.Models.Medicinas
@{
    ViewBag.Title = "Create";
}
<h2>Create</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <h4>Medicinas</h4>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-horizontal">
            <div class="form-group">
                <div class="input-group">
                    <input class="form-control input" type="text" id="tbMedicinaId" placeholder="MedicinaId" />
                    <button class="btn btn-group-sm btn-success" type="button" id="btnBuscar" onclick="BuscarMedicina()">Buscar</button>
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div class="input-group">
                    <input class="form-control input-group-sm col-2" type="text" id="tbMedicina" placeholder="Medicina" />
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div class="input-group">
                    <input class="form-control input-group-sm col-2" type="text" id="tbDescripcion" placeholder="Descripcion" />
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div class="input-group">
                    <input class="form-control input-group-sm col-2" type="text" id="tbPrecioVenta" placeholder="Precio Venta" />
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div class="input-group">
                    <input class="form-control input-group-sm col-2" type="text" id="tbPrecioCompra" placeholder="Precio Compra" />
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div class=" input-group">
                    <input class="form-control input-group-sm col-2" type="date" name="dpFechaVencimiento" id="dpFechaVencimiento" placeholder="Fecha de vencimiento" />
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div class="input-group">
                    <input class="form-control input-group-sm col-2" type="text" id="tbCantidadExistencia" placeholder="Cantidad Existencia" />
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div>
                    <select class="form-control selected" id="ComboBoxL"> <option selected="selected" disabled="disabled">Laboratorios</option></select>
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div class="input-group">
                    <input class="form-control input-group-sm col-2" type="text" id="tbEspecificaciones" placeholder="Especificaciones" />
                </div>
            </div>
            <div class="form-group col-lg-12">
                <div>
                    <select class="form-control selected" id="ComboBoxC"><option selected="selected" disabled="disabled">Categorias</option></select>
                </div>
            </div>
            <div class="form-group text-center col-xl-12">
                <div class="col-md-offset-2 col-md-10">
                    <button type="button" class="btn btn-info col-sm-2" id="btnLimpiar" onclick="LimpiarCampos()">Nuevo</button>
                    <button type="button" class="btn btn-success col-sm-2" id="btnCrear" onclick="ConstruirMedicina(1)">Crear</button>
                    <button type="button" class="btn btn-warning col-sm-2" id="btnModificar" onclick="ConstruirMedicina(2)">Modificar</button>
                    <button type="button" class="btn btn-danger col-sm-2" id="btnEliminar" onclick="ConstruirMedicina(3)">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
}
<div>
    <a asp-action="Index">Back to List</a>
</div>
@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");

        <script type="text/javascript">
            $(document).ready(function () {
                CargarL();
                CargarC();
            })
    
            function ConstruirMedicina(opc) {
                var medicinaId = $('#tbMedicinaId').val();
                var medicamento = $('#tbMedicina').val();
                var descripcion = $('#tbDescripcion').val();
                var precioVenta = $('#tbPrecioVenta').val();
                var precioCompra = $('#tbPrecioCompra').val();
                var fechaV = $('#dtFechaVencimiento').val();
                var cantidad = $('#tbCantidadExistencia').val();
                var a = $('#ComboBoxL').find('option:selected');
                var b = a.attr('id');
                var especificacion = $('#tbEspecificaciones').val();
                var c = $('#ComboBoxC').find('option:selected');
                var d = c.attr('id');

                var medicina = {
                    MedicinaId: 0,
                    Nombre: medicamento,
                    Descripcion: descripcion,
                    PrecioVenta: precioVenta,
                    PrecioCompra: precioCompra,
                    FechaVencimiento: fechaV,
                    CantidadExistencia: cantidad,
                    LaboratorioId: b,
                    Especificaciones: especificacion,
                    CategoriaId: d
                }
                //console.log(medicina);
                //EnviarMedicina(medicina);
                //window.location.reload(false);
                if (opc == 1) {
                    CrearMedicina(medicina);
                } else if (opc == 2) {
                    ModificarMedicina(medicina);
                } else if (opc == 3) {
                    EliminarMedicina(medicina);
                }
            }  

            //function EnviarMedicina(producto) {
            //    $.ajax({
            //        method: "POST",
            //        url: "/Medicinas/Guardar",
            //        data: producto,
            //        success: function (id) {
            //            if (parseInt(id) > 0) {
            //            }
            //            else {
            //                alert("");
            //            }
            //        }
            //    });
            //};

            function CrearMedicina(medicina) {
                $.ajax({
                    method: "POST",                    
                    url: "/Medicinas/Guardar",
                    data: medicina,
                    success: function (resultado) {
                        if (resultado) {
                            alert("La Medicina fue registrado exitosamente.");
                        }
                        else {
                            alert("No se pudo procesar su solicitud");
                        }
                        LimpiarCampos();
                    },
                    error: function (error) {
                        console.log(error);
                    }
                })
            }

            function ModificarMedicina(medicina) {
                $.ajax({
                    method: "POST",                    
                    url: "/Medicines/Modificar",
                    data: medicina,
                    success: function (resultado) {
                        if (resultado) {
                            alert("La Medicina ha sido modificado.");
                        }
                        else {
                            alert("Su solicitud no ha podido ser procesada");
                        }
                        LimpiarCampos();
                    }
                })
            }

            function EliminarMedicina(medicina) {
                $.ajax({
                    method: "POST",                    
                    url: "/Medicinas/Eliminar",
                    data: medicina,
                    success: function (resultado) {
                        if (resultado) {
                            alert("La Medicina ha sido eliminado");
                        }
                        else {
                            alert("La solicitud no ha podido ser procesada");
                        }
                        LimpiarCampos();
                    }
                })
            }

            function BuscarMedicina() {
                var id = $('#tbMedicinaId').val();                
                $.getJSON("/Medicinas/Buscar", { MedicinaId: id }, function (med) {
                    $('#tbMedicina').val(med.medicamento);                    
                    $('#tbMedicina').attr('value', id);                
                    $('#tbDescripcion').val(med.descripcion);
                    $('#tbPrecioVenta').val(med.precioVenta);
                    $('#tbPrecioCompra').val(med.precioCompra);
                    $('#dtFechaVencimiento').val(med.fechaV);
                    $('#tbCantidadExistencia').val(med.cantidad);
                    $('#ComboBoxL').find('opc').remove();
                    $('#ComboBoxC').find('opc').remove();
                    var opL = "<opc id='" + med.laboratorioId + "'value'" + 1 + "'>" + med.b + "</opc>";
                    $('#ComboBoxL').append(opL);
                    $('#tbEspecificaciones').val(med.especificacion);
                    var opC = "<opc id='" + med.categoriaId + "'value'" + 1 + "'>" + med.d + "</opc>";
                    $('#ComboBoxC').append(opC);
                });
                //Cargar();
                //CargarC();
            }           

            function LimpiarCampos() {
                $('#tbMedicinaId').val("");
                $('#tbMedicina').val("");                              
                $('#tbDescripcion').val("");
                $('#tbPrecioVenta').val("");
                $('#tbPrecioCompra').val("");
                //$("#dtFechaVencimiento").datepicker("setDate", "+m");                
                $('#tbCantidadExistencia').val("");
                $('#ComboBoxL').val("");
                $('#tbEspecificaciones').val("");
                $('#ComboBoxC').val("");
            }

            function CargarL() {
                $.getJSON("/Laboratorios/Lista",
                    {
                        id: 1
                    },
                    function (lista) {
                        $.each(lista, function (index, lista) {
                            var Id = lista.laboratorioId;
                            var eso = 1;
                            var Nombre = lista.nombre;
                            var option = "<option id='" + Id + "'value='" + eso + "'>" + Nombre + "</option>";
                            $('#ComboBoxL').append(option);
                        });
                    });
            }
            function CargarC() {
                $.getJSON("/Categorias/Lista",
                    {
                        id: 1
                    },
                    function (lista) {
                        $.each(lista, function (index, lista) {
                            var Id = lista.categoriaId
                            var Nombre = lista.descripcion;
                            var a = 1
                            var option = "<option id='" + Id + "'value='" + a + "'>" + Nombre + "</option>";
                            $('#ComboBoxC').append(option);
                        });
                    });
            }
        </script>
    }
}
